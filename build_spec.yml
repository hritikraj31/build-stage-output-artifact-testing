version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash
env:
  variables:
    "minor_version" : "3.0"
    "repoId" : "ocid1.artifactrepository.oc1.phx.0.amaaaaaab6fywtyansanskq2n4g7jdec262mzywc4h4exiernwlgd2rit3ea"
  exportedVariables:
    - testEnv
    - UIM_DIGEST
    - OCIR_DIGEST

inputArtifacts:
  - name: hello-dev-jar
    location: /workspace/Source1/hello123.class

steps:
  - type: Command
    name: "Build Source"
    timeoutInSeconds: 4000
    command: |
      echo "Testing Output Artifacts Upload from Build Stage"
      echo "This is binary artifact1" > binary_artifact1.txt
      echo "This is binary artifact2" > binary_artifact2.txt
      echo "This is binary artifact3" > binary_artifact3.txt
      mkdir target
      echo "This is binary artifact4" > target/binary_artifact4.txt
      echo "Created all binary artifacts"
      docker build -t built_image -t phx.ocir.io/idllbnfszw6v/hritik-test .
      echo "Docker Build Successful"
      echo $(docker images) > target/images_output.txt
      echo "Completed all steps"
      export UIM_DIGEST=$(sha256sum binary_artifact1.txt | cut -d " " -f 1)
      echo "Uim digest is $UIM_DIGEST"
      docker save -o built_image.tar built_image
      export OCIR_DIGEST=$(sha256sum built_image.tar | cut -d " " -f 1)
      echo "OCIR digest is $OCIR_DIGEST"
      echo "ocir digest is"
      sha256sum phx.ocir.io/idllbnfszw6v/hritik-test.tar
      sleep 5s
      echo "Sleep command exited"

outputArtifacts:
  - name: output1
    type: BINARY
    location: ${OCI_PRIMARY_SOURCE_DIR}/binary_artifact1.txt
    registryId: ${repoId}
    path: target/binary_artifact1
    version: ${minor_version}
  - name: output2
    type: BINARY
    location: ${OCI_WORKSPACE_DIR}/Source/binary_artifact2.txt
    registryId: ${repoId}
    path: target/binary_artifact2
    version: ${minor_version}
  - name: output3
    type: BINARY
    location: /workspace/Source/binary_artifact3.txt
    registryId: ${repoId}
    path: target/binary_artifact3
    version: ${minor_version}
  - name: output4
    type: BINARY
    location: target/binary_artifact4.txt
    registryId: ${repoId}
    path: target/binary_artifact4
    version: ${minor_version}
  - name: image_output
    type: BINARY
    location: target/images_output.txt
    registryId: ${repoId}
    path: target/images_output.txt
    version: ${minor_version}
  - name: output5
    type: DOCKER_IMAGE
    location: built_image
    imageUri: phx.ocir.io/idllbnfszw6v/hritik-test
